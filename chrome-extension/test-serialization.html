<!DOCTYPE html>
<html>
<head>
    <title>Test Message Serialization Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .button { padding: 10px 15px; margin: 5px; background: #007cba; color: white; border: none; border-radius: 3px; cursor: pointer; }
        .button:hover { background: #005a87; }
        .error { color: red; }
        .success { color: green; }
        .warning { color: orange; }
        .code { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; }
        textarea { width: 100%; height: 200px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Kaggie Message Serialization Fix Test</h1>
        
        <div class="section">
            <h2>Storage Management</h2>
            <p>Use these buttons to manage extension storage:</p>
            <button class="button" onclick="clearStorage()">Clear All Storage</button>
            <button class="button" onclick="viewStorage()">View Current Storage</button>
            <button class="button" onclick="testSerialization()">Test Message Serialization</button>
        </div>

        <div class="section">
            <h2>Test Results</h2>
            <div id="results"></div>
        </div>

        <div class="section">
            <h2>Storage Contents</h2>
            <textarea id="storageContents" readonly placeholder="Storage contents will appear here..."></textarea>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            results.appendChild(div);
            console.log(message);
        }

        function clearStorage() {
            if (typeof chrome !== 'undefined' && chrome.storage) {
                chrome.storage.local.clear(() => {
                    if (chrome.runtime.lastError) {
                        log('Error clearing Chrome storage: ' + chrome.runtime.lastError.message, 'error');
                    } else {
                        log('Chrome storage cleared successfully', 'success');
                        document.getElementById('storageContents').value = '';
                    }
                });
            } else {
                localStorage.clear();
                log('Local storage cleared successfully', 'success');
                document.getElementById('storageContents').value = '';
            }
        }

        function viewStorage() {
            if (typeof chrome !== 'undefined' && chrome.storage) {
                chrome.storage.local.get(null, (items) => {
                    if (chrome.runtime.lastError) {
                        log('Error reading Chrome storage: ' + chrome.runtime.lastError.message, 'error');
                    } else {
                        const content = JSON.stringify(items, null, 2);
                        document.getElementById('storageContents').value = content;
                        log('Chrome storage contents loaded', 'success');
                    }
                });
            } else {
                const items = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    items[key] = JSON.parse(localStorage.getItem(key) || 'null');
                }
                const content = JSON.stringify(items, null, 2);
                document.getElementById('storageContents').value = content;
                log('Local storage contents loaded', 'success');
            }
        }

        function testSerialization() {
            log('Testing message serialization...', 'info');

            // Create a mock corrupted LangChain message (like what was causing the error)
            const corruptedMessage = {
                lc_kwargs: {
                    content: "Hello, this is a test message that was corrupted",
                    additional_kwargs: {},
                    name: "test_user"
                },
                lc_namespace: ["langchain", "schema", "messages", "HumanMessage"],
                lc_serializable: true,
                content: "Hello, this is a test message that was corrupted",
                additional_kwargs: {}
            };

            // Create a proper serialized message (what our fix should produce)
            const properMessage = {
                type: 'human',
                content: 'Hello, this is a test message that was corrupted',
                additional_kwargs: {},
                name: 'test_user'
            };

            log('Corrupted message structure detected: ' + JSON.stringify(corruptedMessage, null, 2), 'warning');
            log('Proper serialized format: ' + JSON.stringify(properMessage, null, 2), 'success');

            // Test storage with proper format
            const testData = {
                kaggie_competition_snapshots: [{
                    competitionId: 'test-competition',
                    threadId: 'test-thread',
                    snapshot: {
                        values: {
                            messages: [properMessage]
                        }
                    },
                    lastUpdated: Date.now()
                }]
            };

            if (typeof chrome !== 'undefined' && chrome.storage) {
                chrome.storage.local.set(testData, () => {
                    if (chrome.runtime.lastError) {
                        log('Error saving test data: ' + chrome.runtime.lastError.message, 'error');
                    } else {
                        log('Test data saved successfully with proper message format', 'success');
                        viewStorage();
                    }
                });
            } else {
                localStorage.setItem('kaggie_competition_snapshots', JSON.stringify(testData.kaggie_competition_snapshots));
                log('Test data saved to local storage with proper message format', 'success');
                viewStorage();
            }
        }

        // Auto-load storage contents on page load
        window.addEventListener('load', viewStorage);
    </script>
</body>
</html>
