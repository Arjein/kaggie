<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Key Validation & Error Handling Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .test-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            margin: 10px 0;
        }
        
        .valid { border-color: #10b981; background-color: #f0fdf4; }
        .invalid { border-color: #ef4444; background-color: #fef2f2; }
        .empty { border-color: #ddd; background-color: white; }
        
        .validation-message {
            font-size: 14px;
            margin: 5px 0;
        }
        .valid-msg { color: #10b981; }
        .invalid-msg { color: #ef4444; }
        
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        
        .test-button:hover { background: #2563eb; }
        .test-button:disabled { 
            background: #9ca3af; 
            cursor: not-allowed; 
        }
        
        .result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            font-family: monospace;
        }
        
        .success { background: #d1fae5; border: 1px solid #10b981; }
        .error { background: #fee2e2; border: 1px solid #ef4444; }
        
        .icon {
            display: inline-block;
            margin-left: 10px;
            font-size: 20px;
        }
        
        .valid-icon { color: #10b981; }
        .invalid-icon { color: #ef4444; }
    </style>
</head>
<body>
    <h1>ðŸ”‘ API Key Validation & Error Handling Test</h1>
    <p>Test the new real-time API key validation and enhanced error handling features.</p>

    <!-- OpenAI API Key Testing -->
    <div class="test-section">
        <h2>OpenAI API Key Validation</h2>
        <p>Test different OpenAI API key formats to see real-time validation:</p>
        
        <label for="openai-input">OpenAI API Key:</label>
        <div style="position: relative;">
            <input 
                type="text" 
                id="openai-input" 
                class="test-input" 
                placeholder="Type an OpenAI API key..."
                autocomplete="off"
            />
            <span id="openai-icon" class="icon"></span>
        </div>
        <div id="openai-validation" class="validation-message"></div>
        
        <h3>Test Cases:</h3>
        <button onclick="testOpenAI('')" class="test-button">Test Empty</button>
        <button onclick="testOpenAI('sk-')" class="test-button">Test Short (sk-)</button>
        <button onclick="testOpenAI('sk-proj-abc123')" class="test-button">Test Valid Format</button>
        <button onclick="testOpenAI('sk-proj-1234567890abcdefghijklmnopqrstuvwxyz1234567890')" class="test-button">Test Full Length</button>
        <button onclick="testOpenAI('invalid-key')" class="test-button">Test Invalid Prefix</button>
        <button onclick="testOpenAI('sk-abc!@#')" class="test-button">Test Invalid Characters</button>
    </div>

    <!-- Tavily API Key Testing -->
    <div class="test-section">
        <h2>Tavily API Key Validation</h2>
        <p>Test different Tavily API key formats:</p>
        
        <label for="tavily-input">Tavily API Key:</label>
        <div style="position: relative;">
            <input 
                type="text" 
                id="tavily-input" 
                class="test-input" 
                placeholder="Type a Tavily API key (optional)..."
                autocomplete="off"
            />
            <span id="tavily-icon" class="icon"></span>
        </div>
        <div id="tavily-validation" class="validation-message"></div>
        
        <h3>Test Cases:</h3>
        <button onclick="testTavily('')" class="test-button">Test Empty (Should be valid)</button>
        <button onclick="testTavily('tvly-')" class="test-button">Test Short (tvly-)</button>
        <button onclick="testTavily('tvly-abcdef123456')" class="test-button">Test Valid Format</button>
        <button onclick="testTavily('invalid-tavily')" class="test-button">Test Invalid Prefix</button>
        <button onclick="testTavily('tvly-abc!@#')" class="test-button">Test Invalid Characters</button>
    </div>

    <!-- Error Message Testing -->
    <div class="test-section">
        <h2>Error Message Formatting</h2>
        <p>Test how authentication errors are formatted for users:</p>
        
        <button onclick="testErrorFormat('401 Incorrect API key provided: sk-invalid. You can find your API key at https://platform.openai.com/account/api-keys')" class="test-button">
            Test Raw 401 Error
        </button>
        <button onclick="testErrorFormat('The request failed with status 401')" class="test-button">
            Test Generic 401
        </button>
        <button onclick="testErrorFormat('Network connection failed')" class="test-button">
            Test Non-Auth Error
        </button>
        
        <div id="error-result"></div>
    </div>

    <!-- Live Validation Demo -->
    <div class="test-section">
        <h2>Live Validation Demo</h2>
        <p>Type in the fields below to see real-time validation in action:</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div>
                <label>OpenAI API Key:</label>
                <div style="position: relative;">
                    <input 
                        type="text" 
                        id="live-openai" 
                        class="test-input" 
                        placeholder="sk-proj-..."
                        autocomplete="off"
                    />
                    <span id="live-openai-icon" class="icon"></span>
                </div>
                <div id="live-openai-msg" class="validation-message"></div>
            </div>
            
            <div>
                <label>Tavily API Key:</label>
                <div style="position: relative;">
                    <input 
                        type="text" 
                        id="live-tavily" 
                        class="test-input" 
                        placeholder="tvly-... (optional)"
                        autocomplete="off"
                    />
                    <span id="live-tavily-icon" class="icon"></span>
                </div>
                <div id="live-tavily-msg" class="validation-message"></div>
            </div>
        </div>
        
        <button id="save-button" class="test-button" disabled onclick="simulateSave()">
            Save API Keys
        </button>
        <div id="save-result"></div>
    </div>

    <script>
        // Mock the validation functions that would normally come from the utility
        function validateOpenAIApiKey(apiKey) {
            if (!apiKey || apiKey.trim().length === 0) {
                return {
                    isValid: false,
                    type: 'empty',
                    message: 'OpenAI API key is required'
                };
            }

            const trimmedKey = apiKey.trim();
            const validPrefixes = ['sk-', 'sk-proj-', 'sk-org-'];
            
            const hasValidPrefix = validPrefixes.some(prefix => trimmedKey.startsWith(prefix));
            if (!hasValidPrefix) {
                return {
                    isValid: false,
                    type: 'invalid',
                    message: 'OpenAI API key should start with "sk-", "sk-proj-", or "sk-org-"'
                };
            }

            if (trimmedKey.length < 20) {
                return {
                    isValid: false,
                    type: 'invalid',
                    message: 'OpenAI API key appears to be too short'
                };
            }

            const validCharacters = /^[a-zA-Z0-9\-_]+$/.test(trimmedKey);
            if (!validCharacters) {
                return {
                    isValid: false,
                    type: 'invalid',
                    message: 'OpenAI API key contains invalid characters'
                };
            }

            return {
                isValid: true,
                type: 'valid',
                message: 'OpenAI API key format looks valid'
            };
        }

        function validateTavilyApiKey(apiKey) {
            if (!apiKey || apiKey.trim().length === 0) {
                return {
                    isValid: true,
                    type: 'empty',
                    message: 'Tavily API key is optional'
                };
            }

            const trimmedKey = apiKey.trim();
            
            if (!trimmedKey.startsWith('tvly-')) {
                return {
                    isValid: false,
                    type: 'invalid',
                    message: 'Tavily API key should start with "tvly-"'
                };
            }

            if (trimmedKey.length < 10) {
                return {
                    isValid: false,
                    type: 'invalid',
                    message: 'Tavily API key appears to be too short'
                };
            }

            const validCharacters = /^[a-zA-Z0-9\-_]+$/.test(trimmedKey);
            if (!validCharacters) {
                return {
                    isValid: false,
                    type: 'invalid',
                    message: 'Tavily API key contains invalid characters'
                };
            }

            return {
                isValid: true,
                type: 'valid',
                message: 'Tavily API key format looks valid'
            };
        }

        function formatAuthenticationError(error) {
            const authErrorIndicators = [
                '401',
                'incorrect api key',
                'invalid api key', 
                'unauthorized',
                'authentication failed',
                'api key',
                'openai_api_key'
            ];
            
            const lowerError = error.toLowerCase();
            const isAuthError = authErrorIndicators.some(indicator => lowerError.includes(indicator));
            
            if (isAuthError) {
                return 'Your OpenAI API key appears to be incorrect. Please check your API key in settings and ensure it\'s valid.';
            }
            
            return error;
        }

        function updateValidationUI(inputId, iconId, msgId, validation) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            const msg = document.getElementById(msgId);
            
            // Update input styling
            input.className = `test-input ${validation.type}`;
            
            // Update icon
            if (validation.type === 'valid') {
                icon.innerHTML = 'âœ“';
                icon.className = 'icon valid-icon';
            } else if (validation.type === 'invalid') {
                icon.innerHTML = 'âœ—';
                icon.className = 'icon invalid-icon';
            } else {
                icon.innerHTML = '';
                icon.className = 'icon';
            }
            
            // Update message
            if (validation.message && validation.type !== 'empty') {
                msg.textContent = validation.message;
                msg.className = `validation-message ${validation.type === 'valid' ? 'valid-msg' : 'invalid-msg'}`;
            } else {
                msg.textContent = '';
                msg.className = 'validation-message';
            }
        }

        function testOpenAI(value) {
            document.getElementById('openai-input').value = value;
            const validation = validateOpenAIApiKey(value);
            updateValidationUI('openai-input', 'openai-icon', 'openai-validation', validation);
        }

        function testTavily(value) {
            document.getElementById('tavily-input').value = value;
            const validation = validateTavilyApiKey(value);
            updateValidationUI('tavily-input', 'tavily-icon', 'tavily-validation', validation);
        }

        function testErrorFormat(originalError) {
            const formatted = formatAuthenticationError(originalError);
            const resultDiv = document.getElementById('error-result');
            
            resultDiv.innerHTML = `
                <div class="result error">
                    <strong>Original Error:</strong><br>
                    ${originalError}
                </div>
                <div class="result success">
                    <strong>Formatted Error:</strong><br>
                    ${formatted}
                </div>
            `;
        }

        function updateSaveButton() {
            const openaiValid = validateOpenAIApiKey(document.getElementById('live-openai').value);
            const tavilyValid = validateTavilyApiKey(document.getElementById('live-tavily').value);
            
            const saveButton = document.getElementById('save-button');
            const canSave = openaiValid.isValid && tavilyValid.isValid;
            
            saveButton.disabled = !canSave;
            saveButton.textContent = canSave ? 'Save API Keys' : 'Fix validation errors to save';
        }

        function simulateSave() {
            const resultDiv = document.getElementById('save-result');
            resultDiv.innerHTML = `
                <div class="result success">
                    âœ… API keys saved successfully! Agent would be reinitialized.
                </div>
            `;
        }

        // Set up live validation
        document.getElementById('live-openai').addEventListener('input', function() {
            const validation = validateOpenAIApiKey(this.value);
            updateValidationUI('live-openai', 'live-openai-icon', 'live-openai-msg', validation);
            updateSaveButton();
        });

        document.getElementById('live-tavily').addEventListener('input', function() {
            const validation = validateTavilyApiKey(this.value);
            updateValidationUI('live-tavily', 'live-tavily-icon', 'live-tavily-msg', validation);
            updateSaveButton();
        });

        // Initialize
        updateSaveButton();
    </script>
</body>
</html>
